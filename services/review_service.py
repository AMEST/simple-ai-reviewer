from dataclasses import fields
import json
import logging

from contracts.per_file_review_result import PerFileReviewResult
from services.ai.ai_client import AIClient
from configuration.review_configuration import ReviewConfiguration, Language
from configuration.llm_configuration import LLMConfiguration

from utils.diff_utils import split_diff, get_files_from_diff, get_changed_lines
from utils.text_utils import extract_json_blocks

class ReviewService:
    """
    Service for performing code reviews using AI.
    
    This service analyzes pull request diffs and provides code review feedback
    using an AI client. Supports both Russian and English languages.
    
    Attributes:
        configuration (ReviewConfiguration): Configuration for review settings
        llm_configuration (LLMConfiguration): Configuration for the language model
        ai_client (AIClient): The AI client used for generating reviews
        logger (logging.Logger): Logger instance for service operations
    """
    def __init__(self, configuration: ReviewConfiguration, llm_configuration: LLMConfiguration, ai_client : AIClient):
        """
        Initialize the ReviewService with configurations and AI client.
        
        Args:
            configuration (ReviewConfiguration): Configuration for review settings
            llm_configuration (LLMConfiguration): Configuration for the language model
            ai_client (AIClient): The AI client to use for generating reviews
        """
        self.configuration = configuration
        self.llm_configuration = llm_configuration
        self.ai_client = ai_client
        self.logger = logging.getLogger(ReviewService.__name__)
        self.system_prompt = {
            "role":"system", 
            "content": "–¢—ã –∏–Ω–∂–µ–Ω–µ—Ä-–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç —Å –æ–±—à–∏—Ä–Ω—ã–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏, —Ç—ã –¥–æ–ª–∂–µ–Ω –ø–æ–º–æ—á—å –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ–≤—å—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –∏ –≤—ã–¥–∞—Ç—å —Å–≤–æ–π –≤–µ—Ä–¥–∏–∫—Ç –∫–∞–∫ –ø–æ–ø—Ä–æ—Å–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å. –û—Ç–≤–µ—á–∞—Ç—å –Ω—É–∂–Ω–æ —Å—Ç—Ä–æ–≥–æ –Ω–∞ –†—É—Å—Å–∫–æ–º –Ø–∑—ã–∫–µ –∏ –≤ —Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É—é—Ç (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, —Ç–æ –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ)!" if self.configuration.language == Language.RU else "You are a software engineer with extensive knowledge, you must help review the proposed code and give your verdict as requested by the user. You must answer strictly in English and in the format that is required (if not specified, then in any format)!"
        }

    @property
    def is_comment_review_enabled(self):
        return self.configuration.review_as_comments
    
    @property
    def is_conversation_review_enabled(self):
        return self.configuration.review_as_conversations

    def review_pull_request(self, diff: str, user_message: str = None) -> list[str]:
        """
        Perform a code review on a pull request diff.
        
        Args:
            diff (str): The git diff content to review
            user_message (str, optional): Additional instructions from the user
            
        Returns:
            list[str]: List of review results, one for each diff chunk
        """
        results = []
        splited_diff = split_diff(diff, 12000, self.configuration.ignore_files)
        self.logger.info(f"Received diff (len = {len(diff)}) for automatic review. Split to {len(splited_diff)} diffs")
        for diff_slice in splited_diff:
            file_names = "\n* ".join(get_files_from_diff(diff_slice))
            prompt = self.__en_prompt(diff_slice, user_message) if self.configuration.language == Language.EN else self.__ru_prompt(diff_slice, user_message)
            review_result = self.ai_client.completions([self.system_prompt, {"role":"user","content":prompt}], self.llm_configuration.model)
            results.append(f"ü§ñ AI Code Review:\n\nFiles: \n* {file_names}\n\n{review_result}")
        return results

    def per_file_review_pull_request(self, diff: str) -> list[PerFileReviewResult]:
        """
        Perform a per file code review on a pull request diff.
        
        Args:
            diff (str): The git diff content to review
            
        Returns:
            list[dict]: List of review results, one for each diff chunk
        """
        results = []
        changed_lines = get_changed_lines(diff)
        splited_diff = split_diff(diff, 12000, self.configuration.ignore_files)
        self.logger.info(f"Received diff (len = {len(diff)}) for automatic per file review. Split to {len(splited_diff)} diffs")
        for diff_slice in splited_diff:
            prompt = self.__en_per_file_prompt(diff_slice) if self.configuration.language == Language.EN else self.__ru_per_file_prompt(diff_slice)
            review_result = self.ai_client.completions([self.system_prompt, {"role":"user","content":prompt}], self.llm_configuration.model)
            json_in_result = extract_json_blocks(review_result)
            if len(json_in_result) == 0:
                self.logger.warning("Json not found in per file review!\n%s", review_result)
                continue
            for result in json.loads(json_in_result[0]):
                if not isinstance(result, dict):
                    continue
                review_result_fields = {f.name for f in fields(PerFileReviewResult)}
                per_file_result = PerFileReviewResult(**{k: v for k, v in result.items() if k in review_result_fields})
                changed_lines_in_file : list[int] = changed_lines.get(per_file_result.path)
                if changed_lines_in_file is None:
                    continue
                added_lines = changed_lines_in_file.get("added")
                removed_lines = changed_lines_in_file.get("removed")
                if len(added_lines) > 0:
                    per_file_result.line = min(added_lines, key=lambda x: abs(x - (per_file_result.line + 1)))
                elif len(removed_lines) > 0:
                    per_file_result.line = min(removed_lines, key=lambda x: abs(x - (per_file_result.line + 1)))
                else:
                    continue
                results.append(per_file_result)
        return results

    def __ru_prompt(self, diff: str, user_message: str) -> str:
        """
        Generate a Russian language prompt for the AI review.
        
        Args:
            diff (str): The git diff content to review
            user_message (str): Additional instructions from the user
            
        Returns:
            str: Formatted prompt in Russian
        """
        return f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ diff –∏–∑ git):
```
{diff}
```

–ü—Ä–æ–≤–µ—Ä—å:
0. –ù–∏—á–µ–≥–æ –Ω–µ –ø–∏—à–∏ –ø—Ä–æ diff (–∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–µ–º, —Å–∞–º —Ñ–æ—Ä–º–∞—Ç, –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π), –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –¥–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —É–¥–æ–±—Å—Ç–≤ –∞–Ω–∞–ª–∏–∑–∞
1. –°—Ç–∏–ª—å –∫–æ–¥–∞ (–∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —è–∑—ã–∫—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ñ–∞–π–ª–µ)
2. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏
3. –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
4. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
5. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
{f"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}" if user_message is not None else ""}

–û—Ç–≤–µ—Ç –æ—Ñ–æ—Ä–º–∏ –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ —Å –º–µ—Ç–∫–∞–º–∏: ‚úÖ –ü–ª—é—Å—ã,‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã,üí° –°–æ–≤–µ—Ç—ã{f", üôé‚Äç‚ôÇÔ∏è–æ—Ç–≤–µ—Ç –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" if user_message is not None else ""}
"""
    
    def __en_prompt(self, diff: str, user_message: str) -> str:
        """
        Generate an English language prompt for the AI review.
        
        Args:
            diff (str): The git diff content to review
            user_message (str): Additional instructions from the user
            
        Returns:
            str: Formatted prompt in English
        """
        return f"""Analyze the changes in the code (in diff format from git):
```
{diff}
```

Check:
0. Do not write anything about the diff (changes in it, the format itself, description of changes), the changes are presented in this format only for the convenience of analysis
1. Code style (which corresponds to the programming language in the file)
2. Potential bugs
3. Security vulnerabilities
4. Refactoring opportunities
5. Answer in English language
{f"Additional condition from the user: {user_message}" if user_message is not None else ""}

Format your answer as a list with tags: ‚úÖ Pros, ‚ö†Ô∏è Problems, üí° Tips{f", üôé‚Äç‚ôÇÔ∏èresponse to additional user condition" if user_message is not None else ""}
"""


    def __ru_per_file_prompt(self, diff: str) -> str:
        """
        Generate an Russian language prompt for the per file AI review.
        
        Args:
            diff (str): The git diff content to review
            
        Returns:
            str: Formatted prompt in Russian
        """
        return f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –≤—ã–≤–æ–¥ git diff –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –≤ —Å—Ç—Ä–æ–≥–æ–º —Ñ–æ—Ä–º–∞—Ç–µ JSON:

```diff
{diff}
```
–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç:

1. –û—à–∏–±–æ–∫ (—Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö/–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö)
2. –ù–∞—Ä—É—à–µ–Ω–∏–π —Å—Ç–∏–ª—è –∫–æ–¥–∞ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è —è–∑—ã–∫–∞)
3. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
4. –£—è–∑–≤–∏–º–æ—Å—Ç–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —É—Ç–µ—á–µ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤

–î–ª—è –∫–∞–∂–¥–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ:
1. –ß–µ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
2. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –∏–∑ diff (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—á–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ)
3. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞

–í—ã–≤–µ–¥–∏—Ç–µ –¢–û–õ–¨–ö–û –º–∞—Å—Å–∏–≤ JSON, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç—Ç–æ–π —Ç–æ—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:
[
{{
"path": "full/file/path/from/diff/header",
"line": INTEGER, // MUST use the line number from diff context
"body": "Description of issue and suggested fix (with code suggestion if applicable)"
}},
...
]

–í–∞–∂–Ω–æ:
1. –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫ –î–û–õ–ñ–ù–´ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –Ω–æ–º–µ—Ä–∞–º —Å—Ç—Ä–æ–∫ –≤ diff
2. –í–∫–ª—é—á–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏–π, —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è–º–∏
3. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤–Ω–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã JSON
4. –î–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–Ω—ã—Ö/–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω–µ—á–Ω—ã–π –ø—É—Ç—å –∏–∑ diff
5. –î–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–µ—á–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏
"""

    def __en_per_file_prompt(self, diff: str) -> str:
        """
        Generate an English language prompt for the per file AI review.
        
        Args:
            diff (str): The git diff content to review
            
        Returns:
            str: Formatted prompt in English
        """
        return f"""Analyze the following git diff output and provide specific improvement suggestions in strict JSON format:

```diff
{diff}
```
Perform detailed analysis of each changed file for:

1. Errors (syntax/logical)
2. Code style violations (language-specific)
3. Potential bugs
4. Security vulnerabilities and resource leaks

For each issue found, provide:
1. Clear description
2. Specific line number from the diff (use the exact line number where change is needed)
3. Suggested code fix

Output ONLY a JSON array following this exact structure:
[
{{
"path": "full/file/path/from/diff/header",
"line": INTEGER, // MUST use the line number from diff context
"body": "Description of issue and suggested fix (with code suggestion if applicable)"
}},
...
]

Important:
1. Line numbers MUST correspond to the actual line numbers in the diff
2. Include only actionable items with specific locations
3. Never add comments outside JSON structure
4. For moved/renamed files, use final path from diff
5. For multiline changes, reference ending line number
"""